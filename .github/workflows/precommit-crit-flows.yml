name: precommit-crit-flows

on:
  pull_request:
    branches: [dev]

# One at a time lane for the shared precommit environment
concurrency:
  group: precommit-deploy
  cancel-in-progress: false # queue newer runs

jobs:
  build:
    # Skip entire job for Dependabot PRs
    if: ${{ github.actor != 'dependabot[bot]' && github.actor != 'dependabot' }}
    runs-on: buildjet-8vcpu-ubuntu-2204
    timeout-minutes: 20

    outputs:
      unit_tests_report: ${{ env.UNIT_TEST_REPORT_FILE }}
      build_artifact: ${{ env.BUILD_ARTIFACT }}
      total_additions: ${{ steps.check_additions.outputs.total_additions }}
      commit_url: ${{ steps.meta.outputs.commit_url }}
      committer: ${{ steps.meta.outputs.committer }}

    env:
      BUILD_DIR: server/dist/s3/
      BUILD_ARTIFACT: ebs.zip
      CHANGELOG_FILE: ./changelog.md
      UNIT_TEST_REPORT_FILE: ./unit-tests.log

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: yarn

      - run: yarn --immutable
      - run: yarn configure
      - run: yarn build:prod

      - name: Derive PR commit metadata
        id: meta
        run: |
          SHA="${{ github.event.pull_request.head.sha }}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/$SHA"
          AUTHOR="$(git show -s --format='%an' "$SHA" || true)"
          echo "COMMIT_URL=$COMMIT_URL" >> "$GITHUB_ENV"
          echo "COMMITTER=$AUTHOR" >> "$GITHUB_ENV"
          echo "commit_url=$COMMIT_URL" >> "$GITHUB_OUTPUT"
          echo "committer=$AUTHOR" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: ${{ env.BUILD_DIR }}${{ env.BUILD_ARTIFACT }}

      - name: Check total PR additions
        id: check_additions
        run: |
          total_additions=$(gh api -H "Accept: application/vnd.github.v3+json" \
            "repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
            | jq -r '.additions')
          test -n "$total_additions" -a "$total_additions" != null
          echo "Found total additions: $total_additions"
          echo "total_additions=$total_additions" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy_to_aws:
    name: Deploy to precommit
    if: ${{ github.actor != 'dependabot[bot]' && github.actor != 'dependabot' }}
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 25

    outputs:
      precommit_url: ${{ steps.fetch_url.outputs.url }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Deploy to precommit environment
        id: deploy
        uses: einaregilsson/beanstalk-deploy@27edd8a0ebe8656ac70654372c73f06f7e9a1027 # v22
        with:
          application_name: Webapp
          aws_access_key: ${{ secrets.WEBTEAM_AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.WEBTEAM_AWS_SECRET_ACCESS_KEY }}
          deployment_package: ${{ needs.build.outputs.build_artifact }}
          environment_name: wire-webapp-precommit
          region: eu-central-1
          use_existing_version_if_available: true
          version_description: ${{ needs.build.outputs.committer }} â€” ${{ needs.build.outputs.commit_url }}
          version_label: ${{ github.run_id }}
          wait_for_deployment: true # âœ… wait until EB is green

      - name: Fetch precommit URL
        id: fetch_url
        run: |
          URL=$(aws elasticbeanstalk describe-environments \
            --region eu-central-1 \
            --environment-names wire-webapp-precommit \
            --query "Environments[0].CNAME" --output text)
          echo "url=https://$URL" >> "$GITHUB_OUTPUT"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.WEBTEAM_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.WEBTEAM_AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: eu-central-1

      - name: Deployment Status
        if: ${{ always() }}
        run: |
          if [[ "${{ steps.deploy.outcome }}" == "success" ]]; then
            echo "âœ… Deployment completed successfully"
          else
            echo "âŒ Deployment failed"; exit 1
          fi

  build_testservice:
    name: Build Kalium Test Service
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          repository: wireapp/kalium
          ref: main

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle Cache
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # SHA of tag v5.0.0

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # SHA of tag v5.0.0

      - name: Build the testservice
        run: ./gradlew :testservice:shadowJar

      - name: Upload jar
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: kalium-testservice
          path: |
            testservice/build/libs/
            testservice/config.yml
          retention-days: 1

  e2e_crit_flow:
    name: Playwright Critical Flow (precommit)
    if: ${{ !cancelled() && github.repository == 'wireapp/wire-webapp' && github.actor != 'dependabot[bot]' && github.actor != 'dependabot' }}
    runs-on: ubuntu-latest
    needs: [deploy_to_aws, build_testservice]
    timeout-minutes: 35
    strategy:
      fail-fast: false
      matrix:
        # prettier-ignore
        shard: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32]

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: yarn

      - name: Download Testservice Jar
        uses: actions/download-artifact@v5
        with:
          name: kalium-testservice
          path: testservice

      - run: yarn --immutable
      - run: yarn playwright install --with-deps chrome
      - uses: 1password/install-cli-action@143a85f84a90555d121cde2ff5872e393a47ab9f

      - name: Generate env file
        run: op inject -i test/e2e_tests/.env.staging.tpl -o test/e2e_tests/.env
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      # Log which URL will be used for tests (deploy output vs fallback) and probe if env responds
      - name: Show target URL + quick probe
        run: |
          echo "Using precommit URL: https://wire-webapp-precommit.zinfra.io/"
          curl -s -o /dev/null -w "HTTP %{http_code}\n" https://wire-webapp-precommit.zinfra.io/

      - name: Start Testservice in background
        id: start-testservice
        run: |
          java -jar testservice/build/libs/testservice-*-all.jar server testservice/config.yml &
          echo TESTSERVICE_PID=$! >> "$GITHUB_OUTPUT"

      - name: Run critical flow tests
        env:
          # TODO: remove hardcoded precommit env in the future when ephemeral PR envs will exist
          # Overrides URL from .env file
          WEBAPP_URL: https://wire-webapp-precommit.zinfra.io/
          TEST_SERVICE_URL: http://localhost:8080 # Run tests against locally running test service
        run: yarn e2e-test --shard=${{ matrix.shard }}/${{ strategy.job-total }} --grep "@TC-3461" --trace "on" --repeat-each 32 --retries 0

      - name: Upload blob report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: blob-report
          retention-days: 1

      - name: Stop Testservice
        run: kill -SIGKILL $TESTSERVICE_PID
        env:
          TESTSERVICE_PID: ${{ steps.start-testservice.outputs.TESTSERVICE_PID }}

  e2e-report:
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    needs: [e2e_crit_flow]
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: yarn
      - run: yarn --immutable

      - name: Download blob reports
        uses: actions/download-artifact@v5
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge playwright reports
        run: yarn playwright merge-reports --config ./playwright.config.ts ./all-blob-reports

      - name: Upload test report
        id: upload_playwright_report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      - name: Generate PR comment
        if: always()
        id: generate_comment
        run: |
          node --experimental-strip-types test/e2e_tests/scripts/create-playwright-report-summary.ts
          COMMENT=$(cat playwright-report-summary.txt)
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: always()
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405
        with:
          header: playwright-summary
          message: |
            ðŸ”— [Download Full Report Artifact](${{ steps.upload_playwright_report.outputs.artifact-url }})

            ${{ steps.generate_comment.outputs.comment }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
